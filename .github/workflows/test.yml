name: Run Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  app-tests:
    name: App Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run app tests
        run: bun run test

      - name: Check app build
        run: bun run build

      - name: Run typecheck
        run: bun run typecheck

  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run lint
        run: |
          echo "🔍 Running lint checks..."
          bun run lint || {
            echo "❌ Lint found issues. See above for details."
            echo "ℹ️  Run 'bun run format' to auto-fix some issues."
            exit 1
          }

      - name: Lint Summary
        if: success()
        run: |
          echo "✅ All lint checks passed!"
          echo "✅ Code formatting is correct!"
          echo "🎉 Code quality standards met!"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [app-tests, lint-and-format]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run integration smoke tests
        run: |
          echo "✅ App tests passed"
          echo "✅ App build successful"
          echo "✅ Lint and format checks passed"
          echo "✅ Integration checks complete"
